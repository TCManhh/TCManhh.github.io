<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>
      Trình chiếu: 7-OOP_Dahinh.pdf - Lập trình hướng đối tượng - StuShare
    </title>
    <meta
      name="description"
      content="Tài liệu slide về tính đa hình trong Lập trình hướng đối tượng. Môn Lập trình hướng đối tượng của TS. Nguyễn Đức Anh."
    />
    <meta
      name="keywords"
      content="đa hình, polymorphism, oop, lập trình hướng đối tượng, UET, INT2204, StuShare, tài liệu, TS. Nguyễn Đức Anh"
    />
    <link
      rel="canonical"
      href="https://tcmanhh.github.io/truong-dai-hoc/uet/cntt-lthdt/slides/TS_Nguyen_Duc_Anh/7-OOP_Dahinh-viewer.html"
    />
    <meta
      property="og:title"
      content="Slide: Tính Đa hình (Polymorphism) - Lập trình hướng đối tượng - StuShare"
    />
    <meta
      property="og:description"
      content="Tài liệu slide về tính đa hình trong Lập trình hướng đối tượng. Môn Lập trình hướng đối tượng của TS. Nguyễn Đức Anh."
    />
    <meta property="og:type" content="article" />
    <meta
      property="og:url"
      content="https://tcmanhh.github.io/truong-dai-hoc/uet/cntt-lthdt/slides/TS_Nguyen_Duc_Anh/7-OOP_Dahinh-viewer.html"
    />
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "LearningResource",
        "name": "Slide: Tính Đa hình trong OOP",
        "description": "Tài liệu slide về tính đa hình (Polymorphism), môn Lập trình hướng đối tượng (INT2204) của TS. Nguyễn Đức Anh tại UET.",
        "learningResourceType": "Presentation"
      }
    </script>
  </head>
  <body class="has-fixed-breadcrumb">
    <div id="header-placeholder"></div>
    <div id="breadcrumb-placeholder"></div>

    <main>
      <section class="document-viewer-section">
        <div class="presentation-container">
          <div class="presentation-wrapper">
            <iframe
              loading="lazy"
              src="https://drive.google.com/file/d/1IPFAOGcBB0bFWBD5a9C2a1pMt9ZNvBdw/preview"
              allow="autoplay"
              allowfullscreen
              title="Trình chiếu slide Tính Đa hình trong OOP"
            ></iframe>
          </div>
        </div>

        <div class="viewer-actions">
          <a
            href="https://drive.google.com/file/d/1waRYZdqtKE_dECXTpYYbDdLA_6JBTkUu/view?usp=drive_link"
            class="btn btn-primary"
            target="_blank"
            rel="noopener noreferrer"
            title="Tính năng dành cho thành viên đã đóng góp tài liệu."
            ><i class="fas fa-crown"></i> Tải xuống hoặc In (Thành viên VIP)</a
          >
        </div>
      </section>

      <section class="comments-section" style="padding: 40px 0">
        <div class="container comments-shell">
          <div class="comments-toolbar">
            <h2 class="section-title">Thảo luận</h2>
          </div>

          <form id="comment-form" class="comment-main-form">
            <div class="avatar" id="main-form-avatar">?</div>
            <div class="form-content">
              <div class="form-row">
                <input
                  type="text"
                  id="comment-name"
                  placeholder="Thêm tên của bạn..."
                  required
                />
              </div>
              <div class="form-row">
                <textarea
                  id="comment-text"
                  placeholder="Chia sẻ điều bạn nghĩ..."
                  rows="1"
                  required
                ></textarea>
              </div>
              <input
                type="text"
                id="hp-website"
                name="website"
                autocomplete="off"
                style="display: none"
              />
              <div class="form-actions">
                <button type="button" class="btn btn-secondary cancel-btn">
                  Hủy
                </button>
                <button type="submit" class="btn btn-primary" disabled>
                  Bình luận
                </button>
              </div>
            </div>
          </form>

          <div id="comments-container" class="comments-list">
            <div class="comment-skeleton"></div>
            <div class="comment-skeleton"></div>
            <div class="comment-skeleton"></div>
          </div>

          <div class="comments-footer">
            <button
              id="comments-load-more"
              class="btn btn-secondary"
              style="display: none"
            >
              Xem thêm
            </button>
          </div>

          <div id="comments-toast" class="toast"></div>
        </div>
      </section>
    </main>

    <div id="footer-placeholder"></div>
    <script src="/assets/js/layout.js"></script>
    <script>
      let FORM_STARTED_AT = Date.now(); // đo thời gian điền form
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const SCRIPT_URL =
          "https://script.google.com/macros/s/AKfycbxGdIvBCFFCQGvX0bJxdrIMVz3uP5mZ9L7pEper1YiGQMp2HOtXwCMXNjCfJ7MD0exA/exec"; // QUAN TRỌNG
        const PAGE_ID = window.location.pathname.replace(/[^a-zA-Z0-9]/g, "_");

        // === DEVICE ID MANAGEMENT ===
        function ensureDeviceId() {
          let uid = localStorage.getItem("ss_device_id");
          if (!uid) {
            uid =
              "d_" + Date.now() + "_" + Math.random().toString(36).slice(2, 9);
            localStorage.setItem("ss_device_id", uid);
          }
          return uid;
        }
        const DEVICE_ID = ensureDeviceId();

        // === STATE QUẢN LÝ TRẠNG THÁI ===
        const state = { raw: [], tree: [], page: 1, pageSize: 10 };

        // === DOM ELEMENTS ===
        const el = {
          container: document.getElementById("comments-container"),
          form: document.getElementById("comment-form"),
          nameInput: document.getElementById("comment-name"),
          commentInput: document.getElementById("comment-text"),
          formActions: document.querySelector(
            ".comment-main-form .form-actions"
          ),
          mainAvatar: document.getElementById("main-form-avatar"),
          submitBtn: document.querySelector(
            '.comment-main-form button[type="submit"]'
          ),
          cancelBtn: document.querySelector(".comment-main-form .cancel-btn"),
          loadMore: document.getElementById("comments-load-more"),
          toast: document.getElementById("comments-toast"),
        };

        // === HELPER FUNCTIONS ===
        const formatTimeAgo = (dateInput) => {
          const date = new Date(dateInput);
          if (isNaN(date.getTime())) return "";
          const now = new Date();
          const seconds = Math.round((now - date) / 1000);
          if (seconds < 5) return "vừa xong";
          const minutes = Math.round(seconds / 60);
          const hours = Math.round(minutes / 60);
          const days = Math.round(hours / 24);
          if (minutes < 60) return `${minutes} phút trước`;
          if (hours < 24) return `${hours} giờ trước`;
          return `${Math.round(hours / 24)} ngày trước`;
        };

        const generateCommentId = () =>
          `comment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        const escapeHTML = (str) =>
          String(str).replace(
            /[&<>"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[m])
          );

        const showToast = (msg, isSuccess = true) => {
          if (!el.toast) return;
          el.toast.textContent = msg;
          el.toast.style.background = isSuccess ? "#28a745" : "#dc3545";
          el.toast.classList.add("show");
          setTimeout(() => el.toast.classList.remove("show"), 10000);
        };

        const nameToColor = (name) => {
          let hash = 0;
          for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
          }
          const h = hash % 360;
          return `hsl(${h}, 70%, 60%)`;
        };

        const getRandomColor = () => {
          const h = Math.floor(Math.random() * 360);
          return `hsl(${h}, 70%, 60%)`;
        };

        // === CORE LOGIC: DATA PROCESSING & RENDERING ===
        const buildCommentTree = (comments) => {
          const commentMap = new Map();
          comments.forEach((c) => {
            if (c && c.comment_id)
              commentMap.set(c.comment_id, { ...c, replies: [] });
          });
          const tree = [];
          commentMap.forEach((comment) => {
            if (comment.parent_id && commentMap.has(comment.parent_id)) {
              commentMap.get(comment.parent_id).replies.push(comment);
            } else {
              tree.push(comment);
            }
          });
          return tree;
        };

        const createCommentHTML = (comment, level = 1) => {
          const author = escapeHTML(comment.name || "Ẩn danh");
          const initial = author.charAt(0).toUpperCase();
          const avatarColor = nameToColor(author);
          const timeDisplay = formatTimeAgo(comment.timestamp);
          const body = escapeHTML(comment.comment || "").replace(/\n/g, "<br>");
          const cid = escapeHTML(comment.comment_id);
          const replyButtonHTML =
            level < 4
              ? `<button class="reply-btn-text reply-btn" data-comment-id="${cid}">Trả lời</button>`
              : "";

          return `
            <div class="thread-item">
              <div class="avatar" style="background-color: ${avatarColor};">${initial}</div>
              <div class="col">
                <div class="meta">
                  <span class="author">${author}</span>
                  <span class="time">${timeDisplay}</span>
                </div>
                <div class="body">${body}</div>
                <div class="actions">
                  <button class="action-btn like-btn" data-cid="${cid}">
                    <i class="far fa-thumbs-up"></i><span class="like-count" style="margin-left: 4px;">${
                      comment.like_count || 0
                    }</span></button
                  ><button class="action-btn dislike-btn" data-cid="${cid}">
                    <i class="far fa-thumbs-down"></i><span class="dislike-count" style="margin-left: 4px;">${
                      comment.dislike_count || 0
                    }</span></button
                  >${replyButtonHTML}
                </div>
                <div class="reply-form-container" id="reply-form-for-${cid}"></div>
                <div class="replies" id="replies-to-${cid}"></div>
              </div>
            </div>`;
        };

        const renderCommentList = (comments, container, level = 1) => {
          const sorted = comments
            .slice()
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          const frag = document.createDocumentFragment();
          sorted.forEach((c) => {
            const wrapper = document.createElement("div");
            wrapper.className = "thread";
            wrapper.innerHTML = createCommentHTML(c, level);
            frag.appendChild(wrapper);
            if (Array.isArray(c.replies) && c.replies.length && level < 4) {
              const repliesContainer = wrapper.querySelector(
                `#replies-to-${c.comment_id}`
              );
              if (repliesContainer)
                renderCommentList(c.replies, repliesContainer, level + 1);
            }
          });
          container.innerHTML = "";
          container.appendChild(frag);
        };

        const reRenderWithControls = () => {
          const sorted = state.tree
            .slice()
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          const end = state.page * state.pageSize;
          renderCommentList(sorted.slice(0, end), el.container);
          el.loadMore.style.display =
            sorted.length > end ? "inline-block" : "none";
        };

        // === API & EVENT HANDLING ===
        window.renderCommentsJSONP = function (resp) {
          try {
            if (!resp || !resp.success)
              throw new Error(resp?.error || "Không xác định");
            state.raw = resp.data || [];
            state.tree = buildCommentTree(state.raw);

            if (state.raw.length === 0) {
              el.container.innerHTML =
                "<p>Chưa có bình luận nào. Hãy là người đầu tiên!</p>";
              el.loadMore.style.display = "none";
              return;
            }
            reRenderWithControls();
          } catch (err) {
            el.container.innerHTML = `<p style="color:red;">Lỗi tải bình luận: ${err.message}</p>`;
          }
        };

        async function loadComments() {
          el.container.innerHTML =
            '<div class="comment-loader">Đang tải bình luận<span>.</span><span>.</span><span>.</span></div>';
          const s = document.createElement("script");
          s.src = `${SCRIPT_URL}?page_id=${encodeURIComponent(
            PAGE_ID
          )}&callback=renderCommentsJSONP`;
          s.onerror = () => {
            s.remove();
            el.container.innerHTML =
              '<p style="color:red;">Lỗi kết nối đến máy chủ bình luận.</p>';
            s.remove();
          };
          s.onload = () => s.remove();
          document.body.appendChild(s);
        }

        async function postComment({ name, comment, parent_id }) {
          const body = new URLSearchParams({
            name,
            comment,
            page_id: PAGE_ID,
            comment_id: generateCommentId(),
            parent_id: parent_id || "",
            device_id: DEVICE_ID,
            website: document.getElementById("hp-website")?.value || "",
            form_started_at: String(FORM_STARTED_AT),
          });

          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            },
            body,
          });
          const result = await response.json();
          if (!result.success)
            throw new Error(result.error || "Gửi bình luận thất bại.");
        }

        async function postReaction({ comment_id, reaction }) {
          const body = new URLSearchParams({
            action: "react",
            page_id: PAGE_ID,
            comment_id,
            device_id: DEVICE_ID,
            reaction,
          });
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            },
            body,
          });
          const result = await response.json();
          if (!result.success)
            throw new Error(result.error || "Gửi phản ứng thất bại.");
        }

        const handleFormInteraction = () => {
          el.formActions.style.display = "flex";
          el.commentInput.rows = 2;
        };

        const resetMainForm = () => {
          el.form.reset();
          el.formActions.style.display = "none";
          el.submitBtn.disabled = true;
          el.commentInput.rows = 1;
          updateMainAvatar("?");
        };

        const updateMainAvatar = (name) => {
          const initial = name.charAt(0).toUpperCase();
          el.mainAvatar.textContent = initial;
          el.mainAvatar.style.backgroundColor =
            name === "?" ? getRandomColor() : nameToColor(name);
          el.mainAvatar.style.color =
            name === "?" ? "var(--dark-color)" : "#fff";
        };

        el.nameInput.addEventListener("input", () =>
          updateMainAvatar(el.nameInput.value || "?")
        );
        el.commentInput.addEventListener("input", () => {
          el.submitBtn.disabled = el.commentInput.value.trim() === "";
        });
        el.commentInput.addEventListener("focus", handleFormInteraction);
        el.nameInput.addEventListener("focus", handleFormInteraction);
        el.cancelBtn.addEventListener("click", resetMainForm);

        el.form.addEventListener("submit", async (e) => {
          e.preventDefault();
          el.submitBtn.disabled = true;
          el.submitBtn.innerHTML = `<i class="fas fa-spinner fa-pulse"></i> Đang tải lên...`;
          try {
            await postComment({
              name: el.nameInput.value,
              comment: el.commentInput.value,
              parent_id: null,
            });
            resetMainForm();
            showToast("Đã gửi bình luận!");
            loadComments();
          } catch (error) {
            showToast(`Lỗi: ${error.message}`, false);
          } finally {
            el.submitBtn.disabled = false;
            el.submitBtn.innerHTML = "Bình luận";
          }
        });

        el.container.addEventListener("click", async (e) => {
          const likeBtn = e.target.closest(".like-btn");
          const dislikeBtn = e.target.closest(".dislike-btn");

          if (likeBtn) {
            try {
              await postReaction({
                comment_id: likeBtn.dataset.cid,
                reaction: "like",
              });
              showToast("Đã thích!");
              loadComments();
            } catch (error) {
              showToast(`Lỗi: ${error.message}`, false);
            }
            return;
          }

          if (dislikeBtn) {
            try {
              await postReaction({
                comment_id: dislikeBtn.dataset.cid,
                reaction: "dislike",
              });
              showToast("Đã không thích!");
              loadComments();
            } catch (error) {
              showToast(`Lỗi: ${error.message}`, false);
            }
            return;
          }
        });

        el.container.addEventListener("click", (e) => {
          const replyBtn = e.target.closest(".reply-btn");
          if (!replyBtn) return;
          const parentId = replyBtn.dataset.commentId;
          const container = document.getElementById(
            `reply-form-for-${parentId}`
          );

          document.querySelectorAll(".reply-form-container").forEach((c) => {
            if (c.id !== container.id) c.innerHTML = "";
          });

          if (container.innerHTML) {
            container.innerHTML = "";
            return;
          }

          const currentUserName = el.nameInput.value;
          const userInitial = (currentUserName || "?").charAt(0).toUpperCase();
          const avatarColor = currentUserName
            ? nameToColor(currentUserName)
            : "var(--light-color)";
          const textColor = currentUserName ? "#fff" : "var(--dark-color)";

          container.innerHTML = `
            <div class="reply-box">
              <div class="avatar" style="background-color: ${avatarColor}; color: ${textColor};">${userInitial}</div>
              <div class="form-content">
                <form data-parent-id="${parentId}">
                  <textarea placeholder="Viết câu trả lời..." required rows="1"></textarea>
                  <div class="form-actions" style="display: flex;">
                     <button type="button" class="btn btn-secondary cancel-reply-btn">Hủy</button>
                     <button type="submit" class="btn btn-primary">Trả lời</button>
                  </div>
                </form>
              </div>
            </div>`;

          const replyForm = container.querySelector("form");
          const replyTextarea = replyForm.querySelector("textarea");
          replyTextarea.focus();

          container
            .querySelector(".cancel-reply-btn")
            .addEventListener("click", () => {
              container.innerHTML = "";
            });

          replyForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            if (!el.nameInput.value.trim()) {
              showToast(
                "Vui lòng nhập tên của bạn ở khung bình luận chính.",
                false
              );
              el.nameInput.focus();
              return;
            }
            const button = replyForm.querySelector("button[type='submit']");
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-pulse"></i>`;
            try {
              await postComment({
                name: el.nameInput.value,
                comment: replyTextarea.value,
                parent_id: parentId,
              });
              showToast("Đã gửi trả lời!");
              loadComments();
            } catch (error) {
              showToast(`Lỗi: ${error.message}`, false);
              button.disabled = false;
              button.innerHTML = "Trả lời";
            }
          });
        });

        el.loadMore.addEventListener("click", () => {
          state.page++;
          reRenderWithControls();
        });

        function refreshReactionCountersOnly(payload) {
          if (!payload?.success || !Array.isArray(payload.data)) return;
          const byId = {};
          payload.data.forEach((c) => (byId[c.comment_id] = c));
          document.querySelectorAll(".actions").forEach((act) => {
            const likeBtn = act.querySelector(".like-btn");
            const dislikeBtn = act.querySelector(".dislike-btn");
            if (!likeBtn || !dislikeBtn) return;
            const cid = likeBtn.dataset.cid || dislikeBtn.dataset.cid;
            const rec = byId[cid];
            if (!rec) return;
            const lc = act.querySelector(".like-count");
            const dc = act.querySelector(".dislike-count");
            if (lc) lc.textContent = Number(rec.like_count || 0);
            if (dc) dc.textContent = Number(rec.dislike_count || 0);
          });
        }

        async function pollCounts() {
          try {
            const cb = "poll_cb_" + Date.now();
            window[cb] = function (resp) {
              refreshReactionCountersOnly(resp);
              delete window[cb];
            };
            const s = document.createElement("script");
            s.src = `${SCRIPT_URL}?page_id=${encodeURIComponent(
              PAGE_ID
            )}&callback=${cb}`;
            s.onerror = () => delete window[cb];
            document.body.appendChild(s);
          } catch (_) {}
        }
        setInterval(pollCounts, 15000);

        // === INITIAL LOAD ===
        loadComments();
        updateMainAvatar("?");
      });
    </script>
  </body>
</html>
