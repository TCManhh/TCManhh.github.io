<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trình chiếu: C1-Mở đầu - StuShare</title>
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
  </head>
  <body class="has-fixed-breadcrumb">
    <div id="header-placeholder"></div>
    <div id="breadcrumb-placeholder"></div>

    <main>
      <section class="document-viewer-section">
        <div class="presentation-container">
          <div class="presentation-wrapper">
            <iframe
              src="https://drive.google.com/file/d/1nvbpZ1fwG5Jhm8sOKwS6HbmpH5mm_CuP/preview"
              allow="autoplay"
              allowfullscreen
              title="C1.pptx"
            ></iframe>
          </div>
        </div>

        <div class="viewer-actions">
          <a
            href="https://docs.google.com/presentation/d/1skv7JTJr02Rj8gRNzweqHoYNjZ0QEj34/edit?usp=drive_link&ouid=118172240007661753809&rtpof=true&sd=true"
            class="btn btn-primary"
            target="_blank"
            rel="noopener noreferrer"
            ><i class="fas fa-crown"></i> Tải xuống hoặc In (Thành viên VIP)</a
          >
        </div>
      </section>

      <section class="comments-section" style="padding: 40px 0">
        <div class="container comments-shell">
          <div class="comments-toolbar">
            <h2 class="section-title">Thảo luận</h2>
          </div>

          <form id="comment-form" class="comment-main-form">
            <div class="form-row">
              <input
                type="text"
                id="comment-name"
                placeholder="Tên hiển thị"
                required
              />
            </div>
            <div class="form-row">
              <textarea
                id="comment-text"
                placeholder="Chia sẻ điều bạn nghĩ..."
                rows="4"
                required
              ></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i> Gửi bình luận
              </button>
            </div>
          </form>

          <div id="comments-container" class="comments-list">
            <!-- skeleton khi đang tải -->
            <div class="comment-skeleton"></div>
            <div class="comment-skeleton"></div>
            <div class="comment-skeleton"></div>
          </div>

          <div class="comments-footer">
            <button
              id="comments-load-more"
              class="btn btn-secondary"
              style="display: none"
            >
              Xem thêm
            </button>
          </div>

          <!-- Toast -->
          <div id="comments-toast" class="toast"></div>
        </div>
      </section>
    </main>

    <div id="footer-placeholder"></div>

    <script src="/assets/js/layout.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const SCRIPT_URL =
          "https://script.google.com/macros/s/AKfycbzfgGSk0BsMdN1x8ggwr1OBVKZ4N5BhQP7rjkKK5MevPsoy2vaLUW8KR79G3k0S-yIC/exec"; // QUAN TRỌNG
        const PAGE_ID = window.location.pathname.replace(/[^a-zA-Z0-9]/g, "_");

        // === STATE QUẢN LÝ TRẠNG THÁI ===
        const state = {
          raw: [], // danh sách comment phẳng từ server
          tree: [], // dạng cây
          page: 1,
          pageSize: 10, // mỗi lần hiển thị 10 comment gốc (replies vẫn hiển thị đầy đủ)
        };

        // === DOM ELEMENTS ===
        const el = {
          container: document.getElementById("comments-container"),
          form: document.getElementById("comment-form"),
          nameInput: document.getElementById("comment-name"),
          commentInput: document.getElementById("comment-text"),
          loadMore: document.getElementById("comments-load-more"),
          toast: document.getElementById("comments-toast"),
        };

        // === HELPER FUNCTIONS ===
        const formatTimeAgo = (dateInput) => {
          const date =
            dateInput instanceof Date ? dateInput : new Date(dateInput);
          if (isNaN(date.getTime())) return "";
          const now = new Date();
          const seconds = Math.round((now - date) / 1000);
          if (seconds < 5) return "vừa xong";
          const minutes = Math.round(seconds / 60);
          const hours = Math.round(minutes / 60);
          const days = Math.round(hours / 24);
          if (seconds < 60) return `${seconds} giây trước`;
          if (minutes < 60) return `${minutes} phút trước`;
          if (hours < 24) return `${hours} giờ trước`;
          return `${days} ngày trước`;
        };

        const generateCommentId = () =>
          `comment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        const escapeHTML = (str) =>
          String(str).replace(
            /[&<>"']/g,
            (match) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[match])
          );

        const showToast = (msg, ok = true) => {
          if (!el.toast) return;
          el.toast.textContent = msg;
          el.toast.style.background = ok ? "#1e7e34" : "#b02a37";
          el.toast.classList.add("show");
          setTimeout(() => el.toast.classList.remove("show"), 1800);
        };

        // === CORE LOGIC: DATA PROCESSING & RENDERING ===
        const buildCommentTree = (comments) => {
          const commentMap = new Map();
          comments.forEach((c) => {
            if (c && c.comment_id)
              commentMap.set(c.comment_id, { ...c, replies: [] });
          });
          const tree = [];
          commentMap.forEach((comment) => {
            if (comment.parent_id && commentMap.has(comment.parent_id)) {
              commentMap.get(comment.parent_id).replies.push(comment);
            } else {
              tree.push(comment);
            }
          });
          return tree;
        };

        const createCommentHTML = (
          comment,
          { isLast = false, depth = 0 } = {}
        ) => {
          const author = escapeHTML(comment.name || "Ẩn danh");
          const initial = author.charAt(0).toUpperCase();
          const timeDisplay = formatTimeAgo(comment.timestamp);
          const body = escapeHTML(comment.comment || "").replace(/\n/g, "<br>");
          const cid = escapeHTML(comment.comment_id);
          const depthClass = depth > 0 ? `depth-${Math.min(depth, 3)}` : "";
          return `<div class="thread-item ${depthClass} ${
            isLast ? "is-last" : ""
          }"><div class="avatar">${initial}</div><div class="col"><div class="meta"><span class="author">${author}</span><span class="time">${timeDisplay}</span></div><div class="body">${body}</div><div class="actions"><button class="action-btn reply-btn" data-comment-id="${cid}"><i class="far fa-comment-dots"></i> Reply</button></div><div class="reply-form-container" id="reply-form-for-${cid}"></div><div class="replies" id="replies-to-${cid}"></div></div></div>`;
        };

        const renderCommentList = (comments, container, depth = 0) => {
          const list = (comments || [])
            .slice()
            .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          const frag = document.createDocumentFragment();
          list.forEach((c, idx) => {
            const isLast = idx === list.length - 1;
            const wrapper = document.createElement("div");
            wrapper.className = "thread";
            wrapper.innerHTML = createCommentHTML(c, { isLast, depth });
            frag.appendChild(wrapper);
            if (Array.isArray(c.replies) && c.replies.length) {
              const repliesContainer = wrapper.querySelector(
                `#replies-to-${c.comment_id}`
              );
              if (repliesContainer)
                renderCommentList(c.replies, repliesContainer, depth + 1);
            }
          });
          container.innerHTML = "";
          container.appendChild(frag);
        };

        const reRenderWithControls = () => {
          // Sắp xếp các bình luận gốc theo thời gian từ cũ nhất đến mới nhất
          const sorted = state.tree
            .slice()
            .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          const end = state.page * state.pageSize;
          const slice = sorted.slice(0, end);
          renderCommentList(slice, el.container);
          el.loadMore.style.display =
            sorted.length > end ? "inline-block" : "none";
        };

        // === API & EVENT HANDLING ===
        window.renderCommentsJSONP = function (resp) {
          try {
            if (!resp || !resp.success)
              throw new Error(resp?.error || "Không xác định");
            state.raw = resp.data || [];
            state.tree = buildCommentTree(state.raw);

            if (state.raw.length === 0) {
              el.container.innerHTML =
                "<p>Chưa có bình luận nào. Hãy là người đầu tiên!</p>";
              el.loadMore.style.display = "none";
              return;
            }
            reRenderWithControls();
          } catch (err) {
            el.container.innerHTML = `<p style="color:red;">Lỗi tải bình luận: ${err.message}</p>`;
          }
        };

        async function loadComments() {
          el.container.innerHTML =
            '<div class="comment-skeleton"></div><div class="comment-skeleton"></div>';
          const s = document.createElement("script");
          s.src = `${SCRIPT_URL}?page_id=${encodeURIComponent(
            PAGE_ID
          )}&callback=renderCommentsJSONP`;
          s.onerror = () => {
            el.container.innerHTML =
              '<p style="color:red;">Lỗi tải bình luận (JSONP request thất bại).</p>';
            s.remove();
          };
          s.onload = () => s.remove();
          document.body.appendChild(s);
        }

        async function postComment(payload) {
          const response = await fetch(SCRIPT_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            },
            body: new URLSearchParams(payload).toString(),
          });
          const result = await response.json();
          if (!result.success)
            throw new Error(result.error || "Gửi bình luận thất bại.");
        }

        el.form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const submitButton = el.form.querySelector("button");
          const originalText = submitButton.innerHTML;
          submitButton.disabled = true;
          submitButton.innerHTML =
            '<i class="fas fa-spinner fa-pulse"></i> Đang gửi...';
          try {
            await postComment({
              name: el.nameInput.value,
              comment: el.commentInput.value,
              page_id: PAGE_ID,
              comment_id: generateCommentId(),
              parent_id: null,
            });
            el.form.reset();
            showToast("Đã gửi bình luận!");
            loadComments();
          } catch (error) {
            showToast(`Lỗi: ${error.message}`, false);
          } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
          }
        });

        el.container.addEventListener("click", (e) => {
          const replyBtn = e.target.closest(".reply-btn");
          if (!replyBtn) return;
          const parentId = replyBtn.dataset.commentId;
          const container = document.getElementById(
            `reply-form-for-${parentId}`
          );
          if (container.innerHTML) {
            container.innerHTML = "";
            return;
          }
          container.innerHTML = `<form class="reply-box" data-parent-id="${parentId}"><textarea placeholder="Viết câu trả lời..." required></textarea><button type="submit"><i class="fas fa-paper-plane"></i></button></form>`;
          container.querySelector("textarea").focus();
          container
            .querySelector(".reply-box")
            .addEventListener("submit", async (event) => {
              event.preventDefault();
              const form = event.target,
                textarea = form.querySelector("textarea"),
                button = form.querySelector("button");
              if (!el.nameInput.value.trim()) {
                alert("Vui lòng nhập tên của bạn ở form bình luận chính.");
                el.nameInput.focus();
                return;
              }
              button.disabled = true;
              try {
                await postComment({
                  name: el.nameInput.value,
                  comment: textarea.value,
                  page_id: PAGE_ID,
                  comment_id: generateCommentId(),
                  parent_id: parentId,
                });
                showToast("Đã gửi trả lời!");
                loadComments();
              } catch (error) {
                showToast(`Lỗi: ${error.message}`, false);
                button.disabled = false;
              }
            });
        });

        el.loadMore.addEventListener("click", () => {
          state.page += 1;
          reRenderWithControls();
        });

        // === INITIAL LOAD ===
        loadComments();
      });
    </script>
  </body>
</html>
